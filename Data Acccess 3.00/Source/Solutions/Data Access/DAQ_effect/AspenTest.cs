using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
using System.Data.Odbc;

namespace DAQ
{
    public partial class AspenTest : Form
    {
        public String m_strIP;
        public String IP
        {
            get { return m_strIP; }
            set { m_strIP = value; }
        }
        public String m_strTagName;
        public String TagName
        {
            get { return m_strTagName; }
            set { m_strTagName = value; }
        }
        public AspenTest()
        {
            InitializeComponent();
        }
        public void InitUI()
        {
            this.textBoxIP.Text = this.IP;
        }
        private void AspenTest_Load(object sender, EventArgs e)
        {
            this.CenterToParent();
            this.InitUI();
        }

        public DataSet Query(string SQLString)
        {
            using (OdbcConnection connection = new OdbcConnection("DRIVER={AspenTech SQLplus};HOST=" + this.textBoxIP.Text + ";"))
            {
                DataSet ds = new DataSet();
                try
                {
                    connection.Open();
                    OdbcDataAdapter command = new OdbcDataAdapter(SQLString, connection);
                    command.Fill(ds, "ds");
                }
                catch (OdbcException ex)
                {
                   MessageBox.Show("测试错误:"+ex.Message);
                }
                 catch (Exception ex)
                {
                    MessageBox.Show("测试错误:" + ex.Message);
                }
                finally
                {
                    connection.Close();
                }

                return ds;
            }
        }

        private void btnSearch_Click(object sender, EventArgs e)
        {
            StringBuilder sb = new StringBuilder();
            sb.Append(" select * from IP_AnalogDef ");

            if (this.txtTagName.Text.Trim() != "")
            {
                sb.Append(" where name like '%" + this.txtTagName.Text + "%'");
            }

            DataSet ds = Query(sb.ToString());

            if (ds.Tables.Count > 0)
            {
                this.dataGridView1.DataSource = ds.Tables[0].DefaultView;
                MessageBox.Show("Succeed int getting total " + ds.Tables[0].Rows.Count + " data");

            }
        }
    }
}
